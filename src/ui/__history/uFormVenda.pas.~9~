unit uFormVenda;

interface

uses
  System.SysUtils, System.Types, System.UITypes, System.Classes, System.Variants,
  FMX.Types, FMX.Controls, FMX.Forms, FMX.Graphics, FMX.Dialogs, FMX.StdCtrls,
  FMX.Controls.Presentation, FMX.ListView.Types, FMX.ListView.Appearances,
  FMX.ListView.Adapters.Base, FMX.Edit, FMX.EditBox, FMX.SpinBox, FMX.ListView,
  FMX.ListBox, FMX.Layouts, uVenda, uDMApp, uProcessarPagamentoUseCase;

type
  TFormVenda = class(TForm)
    ToolBar1: TToolBar;
    lblTitulo: TLabel;
    btnVoltar: TButton;
    cmbProdutos: TComboBox;
    lvItens: TListView;
    spQuantidade: TSpinBox;
    btnAdicionarItem: TButton;
    btnPagarDinheiro: TButton;
    btnPagarCartao: TButton;
    btnPagarPix: TButton;
    layFooter: TLayout;
    lblTotal: TLabel;
    procedure FormShow(Sender: TObject);
  private
    FVenda: TVenda;
    procedure CriarNovaVenda;
    procedure CarregarProdutos;
    procedure AtualizarCarrinho;
    procedure ProcessarPagamento(Tipo: TTipoPagamento);

  public
    { Public declarations }
  end;

var
  FormVenda: TFormVenda;

implementation

uses
  uItemVenda, uProduto;

{$R *.fmx}

procedure TFormVenda.FormShow(Sender: TObject);
begin
  CriarNovaVenda;
  CarregarProdutos;
  AtualizarCarrinho;
end;

procedure TFormVenda.AtualizarCarrinho;
var
  Item: TItemVenda;
  P: TProduto;
  ListItem: TListViewItem;
begin
  lvItens.Items.Clear;

  for Item in FVenda.Itens do
  begin
    P := Item.Produto;

    ListItem := lvItens.Items.Add;
    ListItem.Text := P.Nome;
    ListItem.Detail :=
      Format('%d x R$ %.2f = R$ %.2f',
      [Item.Quantidade, P.Preco, Item.ValorTotal]);
  end;

  lblTotal.Text := Format('Total: R$ %.2f', [FVenda.Total]);

end;

procedure TFormVenda.CarregarProdutos;
var
  Lista: TObjectList<TProduto>;
  P: TProduto;
begin
  cmbProdutos.Clear;
  Lista := DMApp.App.ListarProdutos;

  for P in Lista do
    cmbProdutos.Items.AddObject(P.Nome, TObject(P));

end;

procedure TFormVenda.ProcessarPagamento(Tipo: TTipoPagamento);
begin

end;

procedure TFormVenda.CriarNovaVenda;
begin
  FVenda := DMApp.App.CriarVenda;
end;

end.
