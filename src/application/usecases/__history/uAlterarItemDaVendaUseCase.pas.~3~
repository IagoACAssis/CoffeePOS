unit uAlterarItemDaVendaUseCase;

interface

uses
  uVenda, uItemVenda, uRepositorioVenda, uRepositorioProduto;

type
  TAlterarItemDaVendaRequest = record
    VendaId: string;
    ItemId: string;
    NovaQuantidade: Integer;
  end;

  TAlterarItemDaVendaResponse = record
    Venda: TVenda;
  end;

  IAlterarItemDaVendaUseCase = interface
    ['{A8873A4E-89F2-4D46-8301-7B55C77D4F61}']
    function Executar(const AReq: TAlterarItemDaVendaRequest): TAlterarItemDaVendaResponse;
  end;

  TAlterarItemDaVendaUseCase = class(TInterfacedObject, IAlterarItemDaVendaUseCase)
  private
    FRepoVenda: IRepositorioVenda;
  public
    constructor Create(AVendaRepo: IRepositorioVenda);

    function Executar(const AReq: TAlterarItemDaVendaRequest): TAlterarItemDaVendaResponse;
  end;

implementation

uses
  System.SysUtils;

{ TAlterarItemDaVendaUseCase }

constructor TAlterarItemDaVendaUseCase.Create(AVendaRepo: IRepositorioVenda);
begin
  FRepoVenda := AVendaRepo;
end;

function TAlterarItemDaVendaUseCase.Executar(
  const AReq: TAlterarItemDaVendaRequest): TAlterarItemDaVendaResponse;
var
  Venda: TVenda;
begin
  Venda := FRepoVenda.BuscarPorId(AReq.VendaId);

  if not Assigned(Venda) then
    raise Exception.Create('Venda não encontrada.');

  if AReq.NovaQuantidade <= 0 then
    raise Exception.Create('Quantidade inválida.');

  Venda.AlterarQuantidadeItem(AReq.ItemId, AReq.NovaQuantidade);

  Result.Venda := Venda;
end;

end.

